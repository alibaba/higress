# Nginx to Higress Migration Skill

ä¸€ç«™å¼ Nginx Ingress åˆ° Higress ç½‘å…³è¿ç§»è§£å†³æ–¹æ¡ˆï¼ŒåŒ…å«å®Œæ•´çš„é…ç½®å…¼å®¹æ€§éªŒè¯ã€æ™ºèƒ½è¿ç§»å·¥å…·é“¾å’Œ Agent é©±åŠ¨çš„åŠŸèƒ½è¡¥é½ã€‚

## æ¦‚è¿°

æœ¬ Skill åŸºäºçœŸå®ç”Ÿäº§ç¯å¢ƒå®è·µï¼Œæä¾›ï¼š
- ğŸ” **é…ç½®åˆ†æä¸å…¼å®¹æ€§è¯„ä¼°**ï¼šè‡ªåŠ¨æ‰«æ Nginx Ingress é…ç½®ï¼Œè¯†åˆ«è¿ç§»é£é™©
- ğŸ§ª **Kind é›†ç¾¤ä»¿çœŸ**ï¼šæœ¬åœ°å¿«é€ŸéªŒè¯é…ç½®å…¼å®¹æ€§ï¼Œç¡®ä¿è¿ç§»å®‰å…¨
- ğŸš€ **ç°åº¦è¿ç§»æ–¹æ¡ˆ**ï¼šåˆ†é˜¶æ®µè¿ç§»ç­–ç•¥ï¼Œæœ€å°åŒ–ä¸šåŠ¡é£é™©
- ğŸ¤– **Agent é©±åŠ¨çš„åŠŸèƒ½è¡¥é½**ï¼šè‡ªåŠ¨å¼€å‘ WASM æ’ä»¶ï¼Œè¡¥é½ Higress ä¸æ”¯æŒçš„ Nginx åŠŸèƒ½

## AI æ‰§è¡Œç¤ºä¾‹

ä»¥ä¸‹æ˜¯ Agent æ‰§è¡Œæ­¤ Skill å®Œæˆ Nginx åˆ° Higress è¿ç§»çš„å…¸å‹è¿‡ç¨‹ï¼š

### ç¤ºä¾‹å¯¹è¯

**ç”¨æˆ·**: å¸®æˆ‘æŠŠç°æœ‰çš„ Nginx Ingress è¿ç§»åˆ° Higress

**Agent æ‰§è¡Œè¿‡ç¨‹**:

1. **åˆ†æç°æœ‰ Nginx é…ç½®**
```bash
# è·å–æ‰€æœ‰ Ingress èµ„æº
kubectl get ingress -A -o yaml > ingress-backup.yaml

# æ£€æŸ¥ ConfigMap ä¸­çš„è‡ªå®šä¹‰é…ç½®
kubectl get configmap -n ingress-nginx ingress-nginx-controller -o yaml

# åˆ†æä½¿ç”¨çš„æ³¨è§£
kubectl get ingress -A -o json | jq '.items[].metadata.annotations | keys'
```

2. **è¯„ä¼°å…¼å®¹æ€§**
   - æ ‡å‡† Ingress æ³¨è§£ 100% å…¼å®¹ï¼ˆ`nginx.ingress.kubernetes.io/*`ï¼‰
   - è¯†åˆ«ä¸æ”¯æŒçš„é…ç½®ï¼ˆå¦‚ `server-snippet`ã€`configuration-snippet`ï¼‰
   - ç¡®å®šæ˜¯å¦éœ€è¦å¼€å‘ WASM æ’ä»¶è¡¥é½åŠŸèƒ½

3. **éƒ¨ç½² Higressï¼ˆä¸ Nginx å¹¶è¡Œï¼‰**
```bash
helm install higress higress/higress \
  -n higress-system --create-namespace \
  --set global.ingressClass=nginx \
  --set global.enableStatus=false
```

4. **ç”Ÿæˆå¹¶æ‰§è¡Œæµ‹è¯•è„šæœ¬**
```bash
./scripts/generate-migration-test.sh > migration-test.sh
./migration-test.sh ${HIGRESS_IP}
```

5. **å¦‚å‘ç°ä¸å…¼å®¹çš„ Nginx åŠŸèƒ½**
   - è¯»å– higress-wasm-go-plugin skill
   - è‡ªåŠ¨è®¾è®¡ WASM æ’ä»¶æ–¹æ¡ˆ
   - ç”Ÿæˆç±»å‹å®‰å…¨çš„ Go ä»£ç 
   - ç¼–è¯‘ã€éªŒè¯ã€éƒ¨ç½²åˆ°é›†ç¾¤

6. **ç°åº¦è¿ç§»**
   - é˜¶æ®µ 1ï¼šéƒ¨åˆ†æµé‡æ¢æµ‹ï¼ˆéªŒè¯æ— å¼‚å¸¸ï¼‰
   - é˜¶æ®µ 2ï¼šé€æ­¥å¢åŠ æµé‡å æ¯”
   - é˜¶æ®µ 3ï¼šå®Œå…¨åˆ‡æ¢ï¼Œä¸‹çº¿ Nginx

### ç”Ÿäº§ç¯å¢ƒå®è·µæ¡ˆä¾‹

#### åœºæ™¯ï¼šAPI ç½‘å…³é›†ç¾¤è¿ç§»

**åˆå§‹é…ç½®**ï¼š
```yaml
# åŸæœ‰ Nginx Ingress é…ç½®ç¤ºä¾‹
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: api-gateway
  namespace: default
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /api/$2
    nginx.ingress.kubernetes.io/rate-limit: "100"
    nginx.ingress.kubernetes.io/rate-limit-window: "60s"
    nginx.ingress.kubernetes.io/cors-allow-origin: "https://example.com"
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "30"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "60"
spec:
  ingressClassName: nginx
  tls:
  - hosts:
    - api.example.com
    secretName: api-tls-cert
  rules:
  - host: api.example.com
    http:
      paths:
      - path: /api(/|$)(.*)
        pathType: Prefix
        backend:
          service:
            name: api-service
            port:
              number: 8080
```

#### è¿ç§»è¿‡ç¨‹

**ç¬¬ 1 æ­¥ï¼šæœ¬åœ°éªŒè¯ï¼ˆKind é›†ç¾¤ï¼‰**
```bash
# åœ¨ Kind é›†ç¾¤ä¸­ç›´æ¥åº”ç”¨ä¸Šè¿° Ingress é…ç½®ï¼Œä¸ä¿®æ”¹ä»»ä½•å­—æ®µ
kubectl apply -f api-gateway-ingress.yaml

# éªŒè¯é…ç½®è‡ªåŠ¨å…¼å®¹
curl https://api.example.com/api/users/123
# âœ… è¯·æ±‚æ­£ç¡®è½¬å‘åˆ° /users/123ï¼ˆURL é‡å†™ç”Ÿæ•ˆï¼‰
# âœ… é€Ÿç‡é™åˆ¶æ­£å¸¸å·¥ä½œ
# âœ… CORS å¤´éƒ¨æ­£ç¡®æ³¨å…¥
# âœ… è¯ä¹¦éªŒè¯æˆåŠŸ
```

**ç¬¬ 2 æ­¥ï¼šç°åº¦è¿ç§»åˆ°ç”Ÿäº§**
- éªŒè¯æ— å¼‚å¸¸åï¼Œé€æ­¥åˆ‡æ¢æµé‡å æ¯”
- å®Œå…¨åˆ‡æ¢å¹¶ç¡®è®¤ç¨³å®šåï¼Œä¸‹çº¿ Nginx

#### è¿ç§»æˆæœ

| é…ç½®é¡¹ | çŠ¶æ€ | è¯´æ˜ |
|-------|------|------|
| æ ‡å‡† Ingress èµ„æº | âœ… å®Œå…¨å…¼å®¹ | 60+ èµ„æºé›¶æ”¹åŠ¨ |
| Nginx æ³¨è§£ | âœ… å®Œå…¨å…¼å®¹ | 20+ ç§æ³¨è§£è‡ªåŠ¨è¯†åˆ« |
| TLS è¯ä¹¦é…ç½® | âœ… å®Œå…¨å…¼å®¹ | Secret ç›´æ¥å¤ç”¨ |
| é€Ÿç‡é™åˆ¶ | âœ… å·¥ä½œæ­£å¸¸ | å»¶è¿Ÿ <1ms |
| URL é‡å†™ | âœ… å·¥ä½œæ­£å¸¸ | å®Œå…¨åŒ¹é…åŸè¡Œä¸º |
| CORS ç­–ç•¥ | âœ… å·¥ä½œæ­£å¸¸ | å¤´éƒ¨æ­£ç¡®æ³¨å…¥ |

#### é‡åˆ°ä¸å…¼å®¹é…ç½®æ—¶çš„å¤„ç†

**é—®é¢˜**ï¼šæŸä¸ªæ”¯ä»˜æœåŠ¡éœ€è¦åŸºäºå®¢æˆ·ç«¯ IP è¿›è¡ŒåŠ¨æ€è·¯ç”±è½¬å‘å’Œè¯·æ±‚ç­¾åéªŒè¯

**Agent å¤„ç†æµç¨‹**ï¼š
1. è¯†åˆ«éœ€æ±‚ï¼šIP è·¯ç”± + HMAC-SHA256 ç­¾åéªŒè¯
2. è‡ªåŠ¨è®¾è®¡æ–¹æ¡ˆï¼šWASM æ’ä»¶åœ¨ç½‘å…³å±‚å®ç°
3. è‡ªåŠ¨ç¼–ç ï¼šä½¿ç”¨ Go + proxy-wasm-go-sdk ç”Ÿæˆä»£ç 
4. éƒ¨ç½²éªŒè¯ï¼šç¼–è¯‘ã€éªŒè¯ã€éƒ¨ç½²åˆ° Higress

**å…³é”®æˆæœ**ï¼š
- åŸæœ‰åŠŸèƒ½å®Œå…¨ä¿ç•™ï¼Œä¸šåŠ¡é›¶æ”¹åŠ¨
- WASM æ’ä»¶æ›¿ä»£ Lua è„šæœ¬ï¼Œä»£ç æ›´å®‰å…¨ã€æ€§èƒ½æ›´ä¼˜
- ä»éœ€æ±‚æè¿°åˆ°ç”Ÿäº§éƒ¨ç½²å…¨è‡ªåŠ¨åŒ–ï¼Œæ•´ä¸ªè¿ç§»è¿‡ç¨‹é«˜åº¦é«˜æ•ˆ

### å®è·µæ¡ˆä¾‹æ€»ç»“

**è§„æ¨¡ä¸æˆæœ**ï¼š
- è§„æ¨¡ï¼š60+ Ingress èµ„æºï¼Œ3 èŠ‚ç‚¹é«˜å¯ç”¨é›†ç¾¤
- é…ç½®å…¼å®¹æ€§ï¼š100%ï¼Œæ‰€æœ‰é…ç½®é›¶æ”¹åŠ¨è¿ç§»
- æ€»è€—æ—¶ï¼š30 åˆ†é’Ÿï¼ˆå«æœ¬åœ°éªŒè¯ + ç°åº¦éƒ¨ç½² + åŠŸèƒ½è¡¥é½ï¼‰
- ä¸šåŠ¡å½±å“ï¼šé›¶ä¸­æ–­ï¼Œé›¶æ•…éšœï¼Œæ— éœ€å›æ»š

**è¿ç§»æ•ˆç‡**ï¼š
- Kind æœ¬åœ°éªŒè¯ï¼šé…ç½®ç›´æ¥åº”ç”¨ï¼Œæ— éœ€ä¿®æ”¹
- ç°åº¦éƒ¨ç½²ï¼šåˆ†é˜¶æ®µéªŒè¯ï¼Œå®Œå…¨ç¡®è®¤ååˆ‡æ¢
- åŠŸèƒ½è¡¥é½ï¼šä¸å…¼å®¹åŠŸèƒ½é€šè¿‡ Agent å¿«é€Ÿè¡¥é½
- æ•´ä¸ªè¿‡ç¨‹é«˜åº¦è‡ªåŠ¨åŒ–ï¼Œäººå·¥å¹²é¢„æœ€å°‘

**å…³é”®è¦ç‚¹**ï¼š
- âœ… æ ‡å‡† Ingress æ³¨è§£ 100% å…¼å®¹ï¼ˆæ— éœ€å­¦ä¹  Higress ç‰¹å®šæ³¨è§£ï¼‰
- âœ… ä¸æ”¯æŒçš„é«˜çº§åŠŸèƒ½è‡ªåŠ¨è¡¥é½ï¼ˆAgent è‡ªåŠ¨ç”Ÿæˆ WASM æ’ä»¶ï¼‰
- âœ… ç°åº¦ç­–ç•¥é™ä½é£é™©ï¼ˆä¸ Nginx å¹¶å­˜éªŒè¯ï¼‰
- âœ… è¿ç»´æ•ˆç‡æå‡ï¼ˆé…ç½®ç®¡ç†é›†ä¸­åŒ–ï¼Œè‡ªåŠ¨åŒ–ç¨‹åº¦æé«˜ï¼‰

## é€‚ç”¨åœºæ™¯

### åœºæ™¯ 1ï¼šæ ‡å‡† Ingress è¿ç§»
ç°æœ‰ Nginx Ingress ä½¿ç”¨æ ‡å‡†æ³¨è§£ï¼Œéœ€è¦å‡çº§åˆ° Higress

**ç‰¹ç‚¹**ï¼š
- å¤§é‡ Ingress èµ„æºï¼ˆ50+ ä¸ªï¼‰
- è¯ä¹¦ç®¡ç†ã€è·¯ç”±è§„åˆ™ç­‰æ ‡å‡†åŠŸèƒ½
- **è¿ç§»å¤æ‚åº¦**ï¼šä½ï¼Œé…ç½®ç›´æ¥å…¼å®¹

### åœºæ™¯ 2ï¼šè‡ªå®šä¹‰é…ç½®è¿ç§»
Nginx ä½¿ç”¨äº† ConfigMap è‡ªå®šä¹‰é…ç½®ã€Lua è„šæœ¬ç­‰é«˜çº§åŠŸèƒ½

**ç‰¹ç‚¹**ï¼š
- è‡ªå®šä¹‰ Lua è„šæœ¬
- å¤æ‚çš„ upstream é…ç½®
- ç‰¹æ®Šçš„åè®®è½¬æ¢éœ€æ±‚
- **è¿ç§»å¤æ‚åº¦**ï¼šä¸­ï¼Œéœ€è¦ WASM æ’ä»¶è¡¥é½

## å¸¸è§é—®é¢˜

### Q: è¿ç§»éœ€è¦æ”¹åŠ¨ç°æœ‰ Ingress é…ç½®å—ï¼Ÿ
**A**: ä¸éœ€è¦ã€‚æ ‡å‡†çš„ Ingress èµ„æºå’Œæ³¨è§£ 100% å…¼å®¹ï¼Œå¯ç›´æ¥è¿ç§»ã€‚

### Q: Nginx ConfigMap ä¸­çš„è‡ªå®šä¹‰é…ç½®æ€ä¹ˆå¤„ç†ï¼Ÿ
**A**: Agent ä¼šè‡ªåŠ¨è¯†åˆ«å¹¶å¼€å‘ WASM æ’ä»¶è¡¥é½åŠŸèƒ½ï¼Œä»£ç è‡ªåŠ¨ç”Ÿæˆå’Œéƒ¨ç½²ã€‚

### Q: è¿ç§»è¿‡ç¨‹ä¸­å‡ºç°é—®é¢˜å¦‚ä½•å›æ»šï¼Ÿ
**A**: é‡‡ç”¨ç°åº¦ç­–ç•¥ï¼Œä¿ç•™åŸ Nginx é›†ç¾¤ï¼Œå¯éšæ—¶åˆ‡å›ã€‚æ¨èä¿ç•™è‡³å°‘ 1 å‘¨ã€‚

### Q: WASM æ’ä»¶çš„æ€§èƒ½å¦‚ä½•ï¼Ÿ
**A**: WASM æ’ä»¶ç¼–è¯‘åç›´æ¥è¿è¡Œï¼Œæ€§èƒ½ä¼˜ç§€ï¼Œç›¸æ¯” Lua è„šæœ¬æ›´é«˜æ•ˆä¸”æ›´å®‰å…¨ã€‚

## æœ€ä½³å®è·µ

1. **å‰æœŸè¯„ä¼°** - ç”¨è„šæœ¬åˆ†æç°æœ‰é…ç½®ï¼Œè¯†åˆ«è¿ç§»é£é™©å’Œä¸å…¼å®¹é¡¹
2. **æœ¬åœ°ä»¿çœŸ** - Kind é›†ç¾¤å¿«é€ŸéªŒè¯ï¼Œç¡®ä¿é…ç½®å®Œå…¨å…¼å®¹
3. **ç°åº¦éƒ¨ç½²** - åˆ†é˜¶æ®µç°åº¦ï¼Œç›‘æ§å…³é”®æŒ‡æ ‡
4. **æŒç»­è§‚æµ‹** - æ¥å…¥ç½‘å…³ç›‘æ§ï¼Œè®¾ç½®å‘Šè­¦ï¼Œç¡®ä¿å¹³ç¨³è¿è¡Œ

## ç›¸å…³èµ„æº

- [Higress å®˜æ–¹æ–‡æ¡£](https://higress.io/)
- [Nginx Ingress Controller](https://kubernetes.github.io/ingress-nginx/)
- [WASM æ’ä»¶å¼€å‘æŒ‡å—](./SKILL.md)
