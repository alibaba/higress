name: WASM Plugin Unit Tests(GO)

on:
  push:
    branches: [ main ]
    paths:
      - 'plugins/wasm-go/extensions/**'
      - '.github/workflows/wasm-plugin-unit-test.yml'
      - 'go.mod'
      - 'go.sum'
  pull_request:
    branches: [ main ]
    paths:
      - 'plugins/wasm-go/extensions/**'
      - '.github/workflows/wasm-plugin-unit-test.yml'
      - 'go.mod'
      - 'go.sum'

env:
  GO111MODULE: on
  CGO_ENABLED: 0
  GOOS: linux
  GOARCH: amd64

jobs:
  detect-changed-plugins:
    name: Detect Changed Plugins
    runs-on: ubuntu-latest
    outputs:
      changed-plugins: ${{ steps.detect.outputs.plugins }}
      has-changes: ${{ steps.detect.outputs.has-changes }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²ç”¨äºæ¯”è¾ƒ
        
    - name: Detect changed plugins
      id: detect
      run: |
        # è·å–å˜æ›´çš„æ–‡ä»¶åˆ—è¡¨
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          # PRæ¨¡å¼ï¼šæ¯”è¾ƒç›®æ ‡åˆ†æ”¯å’Œæºåˆ†æ”¯
          git fetch origin ${{ github.base_ref }}
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
        else
          # Pushæ¨¡å¼ï¼šæ¯”è¾ƒå½“å‰æäº¤å’Œä¸Šä¸€ä¸ªæäº¤
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
        fi
        
        echo "Changed files:"
        echo "$CHANGED_FILES"
        
        # æå–å˜æ›´çš„æ’ä»¶åç§°
        CHANGED_PLUGINS=""
        for file in $CHANGED_FILES; do
          if [[ $file =~ ^plugins/wasm-go/extensions/([^/]+)/ ]]; then
            PLUGIN_NAME="${BASH_REMATCH[1]}"
            if [[ ! " $CHANGED_PLUGINS " =~ " $PLUGIN_NAME " ]]; then
              CHANGED_PLUGINS="$CHANGED_PLUGINS $PLUGIN_NAME"
            fi
          fi
        done
        
        # å¦‚æœæ²¡æœ‰æ’ä»¶å˜æ›´ï¼Œä¸è§¦å‘æµ‹è¯•
        if [ -z "$CHANGED_PLUGINS" ]; then
          echo "No plugin changes detected, skipping tests"
          echo "has-changes=false" >> $GITHUB_OUTPUT
          echo "plugins=" >> $GITHUB_OUTPUT
        else
          echo "Changed plugins: $CHANGED_PLUGINS"
          echo "has-changes=true" >> $GITHUB_OUTPUT
          echo "plugins=$CHANGED_PLUGINS" >> $GITHUB_OUTPUT
        fi

  test:
    name: Test Changed Plugins
    runs-on: ubuntu-latest
    needs: detect-changed-plugins
    if: needs.detect-changed-plugins.outputs.has-changes == 'true'
    strategy:
      matrix:
        plugin: ${{ fromJson(format('[{0}]', needs.detect-changed-plugins.outputs.changed-plugins)) }}
        go-version: [1.24]
        fail-fast: false
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
      
    - name: Set up Go ${{ matrix.go-version }}
      uses: actions/setup-go@v4
      with:
        go-version: ${{ matrix.go-version }}
        cache: true
        
    - name: Install test tools
      run: |
        go install gotest.tools/gotestsum@latest
        # ç§»é™¤gocovå·¥å…·ï¼Œç›´æ¥ä½¿ç”¨Codecov
        
    - name: Build WASM for ${{ matrix.plugin }}
      working-directory: plugins/wasm-go/extensions/${{ matrix.plugin }}
      run: |
        echo "Building WASM for ${{ matrix.plugin }}..."
        
        # æ£€æŸ¥æ˜¯å¦å­˜åœ¨main.goæ–‡ä»¶
        
        export GOOS=wasip1
        export GOARCH=wasm
        
        # æ„å»ºWASMæ–‡ä»¶ï¼Œå¤±è´¥æ—¶ç›´æ¥é€€å‡º
        if ! go build -buildmode=c-shared -o main.wasm ./; then
          echo "âŒ WASM build failed for ${{ matrix.plugin }}"
          exit 1
        fi
        
        # éªŒè¯WASMæ–‡ä»¶æ˜¯å¦ç”Ÿæˆ
        if [ ! -f "main.wasm" ]; then
          echo "âŒ WASM file not generated for ${{ matrix.plugin }}"
          exit 1
        fi
        
        echo "âœ… WASM build successful for ${{ matrix.plugin }}"

        
    - name: Set WASM_PATH environment variable
      run: |
        echo "WASM_PATH=$(pwd)/plugins/wasm-go/extensions/${{ matrix.plugin }}/main.wasm" >> $GITHUB_ENV
        
    - name: Run tests with coverage for ${{ matrix.plugin }}
      working-directory: plugins/wasm-go/extensions/${{ matrix.plugin }}
      run: |
        # æ£€æŸ¥æ˜¯å¦å­˜åœ¨main_test.goæ–‡ä»¶
        if [ -f "main_test.go" ]; then
          echo "Running tests for ${{ matrix.plugin }}..."
          
          # è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
          gotestsum --junitfile ../../../../test-results-${{ matrix.plugin }}.xml \
                   --format standard-verbose \
                   --jsonfile ../../../../test-output-${{ matrix.plugin }}.json \
                   -- -coverprofile=coverage.out -covermode=atomic ./...
          
          echo "âœ… Tests completed for ${{ matrix.plugin }}"
        else
          echo "No tests found for ${{ matrix.plugin }}, skipping..."
          # åˆ›å»ºç©ºçš„æµ‹è¯•ç»“æœæ–‡ä»¶
          echo '<?xml version="1.0" encoding="UTF-8"?><testsuites><testsuite name="no-tests" tests="0" failures="0" errors="0" time="0"></testsuite></testsuites>' > ../../../../test-results-${{ matrix.plugin }}.xml
        fi
        
    - name: Upload test results for ${{ matrix.plugin }}
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-${{ matrix.plugin }}
        path: |
          test-results-${{ matrix.plugin }}.xml
          test-output-${{ matrix.plugin }}.json
        retention-days: 30
        
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      if: always()
      with:
        file: ./plugins/wasm-go/extensions/${{ matrix.plugin }}/coverage.out
        flags: ${{ matrix.plugin }}-tests
        name: codecov-${{ matrix.plugin }}
        fail_ci_if_error: false
        verbose: true
        token: ${{ secrets.CODECOV_TOKEN }}

  test-summary:
    name: Test Summary & Coverage
    runs-on: ubuntu-latest
    needs: [detect-changed-plugins, test]
    if: always() && needs.detect-changed-plugins.outputs.has-changes == 'true'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download all test results
      uses: actions/download-artifact@v4
      with:
        pattern: test-results-*
        merge-multiple: true
        
    - name: Generate comprehensive test summary
      run: |
        echo "## ğŸ§ª Go Plugin Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        total_plugins=0
        passed_plugins=0
        failed_plugins=0
        total_tests=0
        total_failures=0
        total_errors=0
        
        echo "### ğŸ“Š Test Results by Plugin" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        for result_file in test-results-*.xml; do
          if [ -f "$result_file" ]; then
            plugin_name=$(echo "$result_file" | sed 's/test-results-\(.*\)\.xml/\1/')
            total_plugins=$((total_plugins + 1))
            
            # æ£€æŸ¥WASMæ–‡ä»¶çŠ¶æ€
            wasm_file="plugins/wasm-go/extensions/$plugin_name/main.wasm"
            if [ -f "$wasm_file" ]; then
              wasm_status="âœ…"
            else
              wasm_status="âŒ"
            fi
            
            # è§£æXMLè·å–æµ‹è¯•ç»“æœ
            if grep -q '<testsuite' "$result_file"; then
              tests=$(grep -o 'tests="[0-9]*"' "$result_file" | head -1 | grep -o '[0-9]*')
              failures=$(grep -o 'failures="[0-9]*"' "$result_file" | head -1 | grep -o '[0-9]*')
              errors=$(grep -o 'errors="[0-9]*"' "$result_file" | head -1 | grep -o '[0-9]*')
              time=$(grep -o 'time="[0-9.]*"' "$result_file" | head -1 | grep -o '[0-9.]*')
              
              total_tests=$((total_tests + tests))
              total_failures=$((total_failures + failures))
              total_errors=$((total_errors + errors))
              
              if [ "$failures" = "0" ] && [ "$errors" = "0" ]; then
                echo "âœ… **$plugin_name**: $tests tests passed in ${time}s | $wasm_status WASM" >> $GITHUB_STEP_SUMMARY
                passed_plugins=$((passed_plugins + 1))
              else
                echo "âŒ **$plugin_name**: $tests tests, $failures failures, $errors errors in ${time}s | $wasm_status WASM" >> $GITHUB_STEP_SUMMARY
                failed_plugins=$((failed_plugins + 1))
              fi
            else
              echo "âš ï¸ **$plugin_name**: No tests found | $wasm_status WASM" >> $GITHUB_STEP_SUMMARY
            fi
          fi
        done
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“ˆ Coverage Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ“Š **Coverage reports are now available on Codecov**" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ”— **Project Coverage**: https://codecov.io/gh/${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ”— **This Commit Coverage**: https://codecov.io/gh/${{ github.repository }}/commit/${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ’¡ **Coverage will be automatically commented on this PR**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ğŸ¯ Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Total plugins**: $total_plugins" >> $GITHUB_STEP_SUMMARY
        echo "- **Passed**: $passed_plugins âœ…" >> $GITHUB_STEP_SUMMARY
        echo "- **Failed**: $failed_plugins âŒ" >> $GITHUB_STEP_SUMMARY
        echo "- **Total tests**: $total_tests" >> $GITHUB_STEP_SUMMARY
        echo "- **Total failures**: $total_failures" >> $GITHUB_STEP_SUMMARY
        echo "- **Total errors**: $total_errors" >> $GITHUB_STEP_SUMMARY
        
        # å¦‚æœæœ‰å¤±è´¥ï¼Œæ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
        if [ $total_failures -gt 0 ] || [ $total_errors -gt 0 ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âŒ Failed Tests Details" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Failed plugins**: $failed_plugins" >> $GITHUB_STEP_SUMMARY
          echo "**Total failures**: $total_failures" >> $GITHUB_STEP_SUMMARY
          echo "**Total errors**: $total_errors" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“‹ **View detailed logs**: [Click here](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æ˜¾ç¤ºæ¯ä¸ªå¤±è´¥æ’ä»¶çš„è¯¦ç»†ä¿¡æ¯
          echo "#### ğŸ“Š Failed Plugin Details" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          for result_file in test-results-*.xml; do
            if [ -f "$result_file" ]; then
              plugin_name=$(echo "$result_file" | sed 's/test-results-\(.*\)\.xml/\1/')
              
              # æ£€æŸ¥æ˜¯å¦æœ‰å¤±è´¥
              failures=$(grep -o 'failures="[0-9]*"' "$result_file" | head -1 | grep -o '[0-9]*')
              errors=$(grep -o 'errors="[0-9]*"' "$result_file" | head -1 | grep -o '[0-9]*')
              
              if [ "$failures" -gt 0 ] || [ "$errors" -gt 0 ]; then
                echo "**$plugin_name**:" >> $GITHUB_STEP_SUMMARY
                echo "- Failures: $failures" >> $GITHUB_STEP_SUMMARY
                echo "- Errors: $errors" >> $GITHUB_STEP_SUMMARY
                echo "- [View plugin logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          done
        fi
