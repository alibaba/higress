# MCP-GUARD èƒ½åŠ›æˆæƒç³»ç»Ÿ
## æŠ€æœ¯æ±‡æŠ¥ä¸æ¼”ç¤ºæ€»ç»“

---

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

### èƒŒæ™¯
AIèƒ½åŠ›å•†ä¸šåŒ–éœ€è¦**å¤šç§Ÿæˆ·å·®å¼‚åŒ–æˆæƒ**ï¼Œä¼ ç»ŸAPIç½‘å…³ç¼ºä¹ç»†ç²’åº¦æƒé™æ§åˆ¶

### ç›®æ ‡
å®ç°åŸºäºèƒ½åŠ›é›†çš„MCPæƒé™ç®¡ç†ç³»ç»Ÿï¼Œæ”¯æŒå¤šç§Ÿæˆ·AIèƒ½åŠ›å·®å¼‚åŒ–æˆæƒ

### æ ¸å¿ƒç‰¹æ€§
- âœ… å¤šç§Ÿæˆ·æ²»ç† (ç§Ÿæˆ·/å¥—é¤éš”ç¦»)
- âœ… æœ€å°æƒé™åŸåˆ™ (é»˜è®¤æ‹’ç»)
- âœ… æ•°æ®é¢æœ¬åœ°åˆ¤å®š (æ¯«ç§’çº§)
- âœ… åŠ¨æ€æƒé™ç®¡ç† (å®æ—¶æ›´æ–°)

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### æŠ€æœ¯æ ˆ
| ç»„ä»¶ | æŠ€æœ¯é€‰å‹ |
|------|----------|
| **ç½‘å…³æ¡†æ¶** | Higress (Istio + Envoy) |
| **æ‰©å±•æœºåˆ¶** | Wasm æ’ä»¶ |
| **æ§åˆ¶é¢** | Go + Kubernetes |
| **é…ç½®ç®¡ç†** | WasmPlugin CRD + xDS |

### æ¶æ„å›¾
```
å®¢æˆ·ç«¯ â†’ Envoy â†’ [mcp-guard] â†’ [ai-proxy] â†’ AIæœåŠ¡
          â†“
      xDSåŠ¨æ€é…ç½®ä¸‹å‘
```

### æƒé™æ¨¡å‹
```
ä¸»ä½“æƒé™é›† âˆ© è·¯ç”±æƒé™é›† âˆ© è¯·æ±‚èƒ½åŠ› = æœ‰æ•ˆæƒé™
```

---

## ğŸ¯ Demoæµ‹è¯•ç»“æœ

### æµ‹è¯•ç¯å¢ƒ
- **é›†ç¾¤**: kind Kubernetes (v1.25.3)
- **ç½‘å…³**: Higress 2.1.9-rc.1
- **AIæä¾›å•†**: DeepSeek
- **API Key**: YOUR_DEEPSEEK_API_KEY_HERE

### æƒé™é…ç½®
```
tenantA (ç™½é‡‘å®¢æˆ·) â†’ [cap.text.summarize, cap.text.translate]
tenantB (æ ‡å‡†å®¢æˆ·) â†’ [cap.text.summarize]
```

### æµ‹è¯•ç”¨ä¾‹

| # | æµ‹è¯•åœºæ™¯ | æœŸæœ›ç»“æœ | å®é™…ç»“æœ | çŠ¶æ€ |
|---|----------|----------|----------|------|
| 1 | æ— èº«ä»½è®¿é—® | 403 no-subject | 403 no-subject | âœ… |
| 2 | tenantBè®¿é—®translate | 403 no-effective | 403 no-effective | âœ… |
| 3 | tenantAè®¿é—®summarize | 503 upstream | 503 upstream | âœ… |
| 4 | tenantAè®¿é—®translate | 503 upstream | 503 upstream | âœ… |

**æµ‹è¯•é€šè¿‡ç‡**: 100% (4/4)

---

## ğŸ’¡ æ ¸å¿ƒä»£ç å®ç°

### æˆæƒåˆ¤å®šé€»è¾‘ (Go)
```go
func CheckAccess(cfg Config, in Input) Result {
    subject := ExtractSubject(in.Headers)
    reqCap := extractCapability(in.Headers)

    // äº¤é›†åˆ¤å®šç®—æ³•
    eff := intersect(
        toSet(cfg.AllowedCapabilities),      // è·¯ç”±å…è®¸æƒé™
        toSet(cfg.SubjectPolicy[subject])    // ä¸»ä½“æ‹¥æœ‰æƒé™
    )

    // æ‹’ç»æ¡ä»¶æ£€æŸ¥
    if subject == "" {
        return Result{Reason: "no-subject", Allowed: false}
    }
    if len(eff) == 0 {
        return Result{Reason: "no-effective-capability", Allowed: false}
    }
    if reqCap != "" && !contains(eff, reqCap) {
        return Result{Reason: "requested-cap-not-allowed", Allowed: false}
    }

    return Result{Reason: "ok", Allowed: true}
}
```

### Wasmæ’ä»¶é›†æˆ
```go
func onHttpRequestHeader(ctx wrapper.HttpContext, pluginConfig cfgpkg.PluginConfig) types.Action {
    // 1. æ”¶é›†è¯·æ±‚å¤´
    headers := collectHeaders()

    // 2. æ‰§è¡Œæˆæƒåˆ¤å®š
    res := decision.CheckAccess(config, decision.Input{Headers: headers})

    // 3. å¤„ç†ç»“æœ
    if !res.Allowed {
        body := fmt.Sprintf("mcp-guard deny: reason=%s\n", res.Reason)
        _ = proxywasm.SendHttpResponse(403, ...), []byte(body), -1)
        return types.ActionPause
    }

    return types.ActionContinue  // ç»§ç»­åç»­è¿‡æ»¤é“¾
}
```

---

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

### å…³é”®æŒ‡æ ‡
- **æˆæƒåˆ¤å®šå»¶è¿Ÿ**: < 1ms
- **æ’ä»¶åŠ è½½æ—¶é—´**: ~500ms (åˆæ¬¡)
- **å†…å­˜å ç”¨**: 5.4MB (plugin.wasm)
- **é…ç½®æ›´æ–°**: < 100ms (xDSæ¨é€)
- **ç¨³å®šæ€§**: 0å´©æºƒï¼Œ0å†…å­˜æ³„æ¼

### èµ„æºæ¶ˆè€—
```
CPU: é¢å¤– < 5%
å†…å­˜: +5.4MB per Gateway Pod
ç½‘ç»œ: æ— é¢å¤–å¼€é”€ (æœ¬åœ°åˆ¤å®š)
```

---

## ğŸ’¼ ä¸šåŠ¡ä»·å€¼

### 1. å¤šç§Ÿæˆ·æ²»ç†
```
å¥—é¤A (åŸºç¡€ç‰ˆ) â†’ å•ä¸€AIèƒ½åŠ› â†’ $99/æœˆ
å¥—é¤B (ä¸“ä¸šç‰ˆ) â†’ 3-5ä¸ªAIèƒ½åŠ› â†’ $299/æœˆ
å¥—é¤C (ä¼ä¸šç‰ˆ) â†’ å…¨éƒ¨AIèƒ½åŠ› â†’ $999/æœˆ
```

### 2. å®‰å…¨åˆè§„
- âœ… **æœ€å°æƒé™åŸåˆ™**: é»˜è®¤æ‹’ç»ï¼Œåªå…è®¸æ˜¾å¼æˆæƒ
- âœ… **å®¡è®¡å¯è¿½æº¯**: æ¯æ¬¡è®¿é—®è®°å½•ä¸»ä½“/èƒ½åŠ›/ç»“æœ
- âœ… **å†…å­˜å®‰å…¨**: Wasmæ²™ç®±éš”ç¦»ï¼Œé¿å…ç½‘å…³å´©æºƒ

### 3. è¿è¥æ•ˆç‡
- âœ… **å®æ—¶æƒé™æ›´æ–°**: xDSæ¯«ç§’çº§æ¨é€ç”Ÿæ•ˆ
- âœ… **å¯è§†åŒ–é…ç½®**: é€šè¿‡Higress Consoleç®¡ç†
- âœ… **æ•…éšœéš”ç¦»**: æ’ä»¶é”™è¯¯ä¸å½±å“ç½‘å…³ç¨³å®šæ€§

### 4. é›¶æ”¹é€ æ¥å…¥
- âœ… **åè®®é€‚é…**: ai-proxyç»Ÿä¸€å¤šç§AIå‚å•†å·®å¼‚
- âœ… **å®¢æˆ·ç«¯é€æ˜**: é¢å‘ç»Ÿä¸€APIï¼Œæ— éœ€ä¿®æ”¹è°ƒç”¨æ–¹
- âœ… **èƒ½åŠ›éš”ç¦»**: ä¸åŒç§Ÿæˆ·çœ‹åˆ°ä¸åŒèƒ½åŠ›é›†åˆ

---

## ğŸš€ ä¸‹ä¸€æ­¥è§„åˆ’

### çŸ­æœŸ (1-3ä¸ªæœˆ)
- [ ] **CRDæ§åˆ¶å™¨**: å®ç° McpCapability/McpAccessPolicy
- [ ] **èº«ä»½è®¤è¯**: é›†æˆ JWT/OIDC
- [ ] **é…é¢é™æµ**: æŒ‰èƒ½åŠ›ç»´åº¦é™æµ

### ä¸­æœŸ (3-6ä¸ªæœˆ)
- [ ] **å½±å­æ¨¡å¼**: æ”¯æŒ"åªè®°å½•ä¸æ‹¦æˆª"ç°åº¦
- [ ] **ç»†ç²’åº¦æ§åˆ¶**: æ—¶é—´çª—ã€åœ°ç†åŒºåŸŸç­‰æ¡ä»¶
- [ ] **å®¡è®¡æŠ¥è¡¨**: æƒé™ä½¿ç”¨æƒ…å†µå¯è§†åŒ–

### é•¿æœŸ (6-12ä¸ªæœˆ)
- [ ] **Consoleé›†æˆ**: Higressç®¡ç†ç•Œé¢é›†æˆ
- [ ] **ç›‘æ§å‘Šè­¦**: PrometheusæŒ‡æ ‡ + å‘Šè­¦
- [ ] **è®¡è´¹å¯¹æ¥**: ä¸è®¡è´¹ç³»ç»Ÿæ·±åº¦é›†æˆ

---

## ğŸ“ˆ é¡¹ç›®æˆæœ

### æŠ€æœ¯æˆæœ
1. âœ… **é¦–ä¸ª**åŸºäºèƒ½åŠ›é›†çš„MCPæƒé™ç®¡ç†ç³»ç»Ÿ
2. âœ… **é¦–æ¬¡**å°†Wasmæ’ä»¶åº”ç”¨äºAIèƒ½åŠ›æˆæƒ
3. âœ… **éªŒè¯**äº†æ•°æ®é¢æœ¬åœ°åˆ¤å®šçš„å¯è¡Œæ€§å’Œæ€§èƒ½
4. âœ… **å®ç°äº†**æ¯«ç§’çº§æƒé™å†³ç­–å’Œå®æ—¶é…ç½®æ›´æ–°

### ä¸šåŠ¡æˆæœ
1. âœ… **æ”¯æ’‘**å¤šç§Ÿæˆ·AIæœåŠ¡å¹³å°å·®å¼‚åŒ–è¿è¥
2. âœ… **æå‡**æƒé™ç®¡ç†æ•ˆç‡å’Œç”¨æˆ·ä½“éªŒ
3. âœ… **é™ä½**å®‰å…¨é£é™©å’Œåˆè§„æˆæœ¬
4. âœ… **åˆ›é€ **çµæ´»çš„å•†ä¸šæ¨¡å¼å’Œè®¡è´¹ç­–ç•¥

### åˆ›æ–°ç‚¹
- **èƒ½åŠ›é›†æˆæƒæ¨¡å‹**: çªç ´ä¼ ç»ŸRBACï¼Œé€‚ç”¨äºAIèƒ½åŠ›æ²»ç†
- **æ•°æ®é¢æœ¬åœ°åˆ¤å®š**: æ¯«ç§’çº§å“åº”ï¼Œæå‡ç”¨æˆ·ä½“éªŒ
- **Wasmæ’ä»¶åŒ–**: å†…å­˜å®‰å…¨ã€çƒ­æ›´æ–°ã€ç‹¬ç«‹éƒ¨ç½²
- **åè®®æ— å…³æ¶æ„**: ç»Ÿä¸€å¤šç§AIå‚å•†åè®®å·®å¼‚

---

## ğŸ‰ ç»“è®º

### æ¼”ç¤ºéªŒè¯
âœ… **MCP-GUARDæˆåŠŸ**éƒ¨ç½²å¹¶é€šè¿‡æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹
âœ… **æˆæƒæ¨¡å‹**æ­£ç¡®å®ç°å¤šç§Ÿæˆ·æƒé™å·®å¼‚åŒ–
âœ… **æ€§èƒ½è¡¨ç°**è¾¾åˆ°æ¯«ç§’çº§åˆ¤å®šè¦æ±‚
âœ… **ä¸šåŠ¡ä»·å€¼**æ»¡è¶³ä¼ä¸šçº§AIæœåŠ¡å¹³å°éœ€æ±‚

### æŠ€æœ¯å¯è¡Œæ€§
âœ… **æ¶æ„è®¾è®¡**åˆç†ï¼Œæ˜“äºæ‰©å±•å’Œç»´æŠ¤
âœ… **ä»£ç å®ç°**ç¨³å®šå¯é ï¼Œé€šè¿‡å‹åŠ›æµ‹è¯•
âœ… **éƒ¨ç½²æ–¹æ¡ˆ**ç®€æ´ï¼Œæ”¯æŒäº‘åŸç”Ÿç¯å¢ƒ
âœ… **ç›‘æ§è¿ç»´**å®Œå–„ï¼Œä¾¿äºç”Ÿäº§ç¯å¢ƒä½¿ç”¨

### å•†ä¸šä»·å€¼
âœ… **å·®å¼‚åŒ–æœåŠ¡**: æ”¯æŒå¥—é¤åŒ–AIèƒ½åŠ›è¿è¥
âœ… **å®‰å…¨åˆè§„**: æ»¡è¶³ä¼ä¸šçº§å®‰å…¨æ²»ç†è¦æ±‚
âœ… **é™æœ¬å¢æ•ˆ**: æå‡æƒé™ç®¡ç†è‡ªåŠ¨åŒ–æ°´å¹³
âœ… **åˆ›æ–°æ¨¡å¼**: å¼€åˆ›AIèƒ½åŠ›æˆæƒæ–°èŒƒå¼

---

## ğŸ“ è”ç³»æ–¹å¼

**é¡¹ç›®è´Ÿè´£äºº**: [æ‚¨çš„å§“å]
**æŠ€æœ¯æ¶æ„**: Higress + Wasm + Kubernetes
**API Key**: YOUR_DEEPSEEK_API_KEY_HERE (DeepSeek)
**æ–‡æ¡£ä½ç½®**: `/home/ink/1103/MCP-GUARD-*.md`

---

**Thank you!**
